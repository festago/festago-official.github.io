{"componentChunkName":"component---src-templates-post-jsx","path":"/facade-service/","result":{"data":{"site":{"siteMetadata":{"title":"Festago"}},"markdownRemark":{"id":"337eca9e-cd03-5e90-9d8f-d0b86e0ce4b9","excerpt":"안녕하세요. 페스타고팀의 애쉬입니다. 🏹 페스타고 팀에서 Facade 객체를 활용해 외부 API 통신을 분리한 과정을 설명하고자 합니다. 문제 상황 Oauth2 기반 로그인 메서드에서, Oauth2 API 통신이 트랜잭션 범위 안에 속해있었습니다.  외부 API 통신은 비교적 시간이 오래 걸리는 메서드로, 이가 트랜잭션 범위 안에 포함되면 DB 커넥션을 …","html":"<p>안녕하세요. 페스타고팀의 애쉬입니다. 🏹</p>\n<p>페스타고 팀에서 Facade 객체를 활용해 외부 API 통신을 분리한 과정을 설명하고자 합니다.</p>\n<h2>문제 상황</h2>\n<p>Oauth2 기반 로그인 메서드에서, Oauth2 API 통신이 트랜잭션 범위 안에 속해있었습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f17e8817a7a5a1208c2a9d3e072f391e/ac7a9/image.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXklEQVR42jWQ20vCYADF938EFQiW6dJN3dzt25yXfS6Z9RCBUXQv2y0VU/HSWxAURNEf12PgQ+SDQabOdGsaHc7D7zych3OQp8e769JJtWJeGUbJ1IumC651Q1P1S1VXVVPTNN0omMVTVa83W5ZlOf9Cjg/20xSZTSRlADY4BrI8pABkWZEkRIKIEyQIYywaQFHc6/WDtDLofji9rv3eccYWcnhhiDFCiYsyL8pCQpGkbCqVk2AOwk0IFQnKyTgEnCgINBlVdnZ7/dH3aPLZH02mNpI/UwOhkJTJcAJPsxwHeIblKJaJUVSMZgiKJl2iGRbw4Qgub+c7/cnb0Hn9sodTB9naO1rwrOA4FiapEEFjBBUlAYpFfEF8dR3zoSF/EPcFw561wOLSMpnMDqwfd61t27PND88v5+W6UW1olYZea2vVplptGrW2Ub9xoz6HObcK5Vrj9t4a/5Vnh/0CClyf3Yf40lQAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image' title='' src='/static/f17e8817a7a5a1208c2a9d3e072f391e/ca1dc/image.png' srcset='/static/f17e8817a7a5a1208c2a9d3e072f391e/e7570/image.png 170w,\n/static/f17e8817a7a5a1208c2a9d3e072f391e/f46e7/image.png 340w,\n/static/f17e8817a7a5a1208c2a9d3e072f391e/ca1dc/image.png 680w,\n/static/f17e8817a7a5a1208c2a9d3e072f391e/02d09/image.png 1020w,\n/static/f17e8817a7a5a1208c2a9d3e072f391e/9d567/image.png 1360w,\n/static/f17e8817a7a5a1208c2a9d3e072f391e/ac7a9/image.png 1920w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>외부 API 통신은 비교적 시간이 오래 걸리는 메서드로, 이가 트랜잭션 범위 안에 포함되면 DB 커넥션을 가지고 있는 시간과 트랜잭션이 활성화된 시간이 불필요하게 길어집니다. 이는 성능 저하와 직결되는 문제입니다.</p>\n<p>따라서 외부 API 통신 코드를 트랜잭션 범위에서 분리하는 것이 바람직합니다.</p>\n<h2>Facade 패턴 적용</h2>\n<p>파사드 패턴(Facade Pattern)을 적용하여 해당 문제를 해결하였습니다.</p>\n<p>파사드 패턴이란, 서브 시스템을 감추는 상위 수준의 인터페이스를 제공함으로써 시스템의 복잡도를 낮추는 디자인 패턴입니.</p>\n<p>우리 팀은 아래와 같이 AuthService 상위에 AuthFacadeService 객체를 도입함으로써, 트랜잭션의 범위를 최소한으로 줄였습니다.</p>\n<p>(외부 API 통신과 함께, accessToken 생성 로직도 트랜잭션 범위에서 제외하였습니다.)</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/75daedbc615b4425d1b92b635e667cf4/ac7a9/image-1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 77.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8klEQVR42n1SiZKcIBT0//9us/fO5ew4KsgNPm4MmqpsMrNJV0sh0vbrB83hcKCULstSSqnPkvMX6ytAJrRMpDBecln+RmOtTSktm3rxfvFhCRtjWlJ2SuhxJ4cPjY7Zwq34a1qtqnhDCEEpZWZgDGl+YGQn2DGDuRVzkAKkdrOvJcygrNc2EGkwIfM8x+AE6wTtlBgS3Dm/4v3LuNvRFuFxunTvA3/8JPvJEKFhBjReyPA4dg9keIlGb5Kv5I12RnsjnUkhFFiduQHM5ESo0dqCqZ5GjkbiDP/P7NbMMcYaWGldQ1Paa7Fj+FWLY7rPXP6Ec9na7NzW9pVBMiDtTFpgl+zdN+KbpfXEc/7F5f5z2Q51W25ObXvpLhXn8/na94fjESH0e2dKUcuhNlzLMQZ/65xTzptJnaQNuZQ6AkCtmnPC8TPpf9TRObMa1r7YSld71IC3GoyxJsRQ/xC8j3WXUhghIYQHYGjkE2J4iABJCd+1oTu5S1usa/b0/IL3H/R4nfpxRH296qcTa1vS91VMR7zH+vXKT9wRrsb+OKGnCT0T9FZbu94wOnM6Cxtc7Y41xkkJQnBC9FqQoZhMlWgKZg5KAO1negU2FO+b5Q41MGVMrJCMYkXeOHrS9D1F/+9L8h1i9Ip/SnaS7DOlcCP+Cba3mdnwYn4nAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image 1' title='' src='/static/75daedbc615b4425d1b92b635e667cf4/ca1dc/image-1.png' srcset='/static/75daedbc615b4425d1b92b635e667cf4/e7570/image-1.png 170w,\n/static/75daedbc615b4425d1b92b635e667cf4/f46e7/image-1.png 340w,\n/static/75daedbc615b4425d1b92b635e667cf4/ca1dc/image-1.png 680w,\n/static/75daedbc615b4425d1b92b635e667cf4/02d09/image-1.png 1020w,\n/static/75daedbc615b4425d1b92b635e667cf4/9d567/image-1.png 1360w,\n/static/75daedbc615b4425d1b92b635e667cf4/ac7a9/image-1.png 1920w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>아래는 파사드 객체를 도입한 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthFacadeService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuth2Clients</span> oAuth2Clients<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthProvider</span> authProvider<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/***/</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LoginResponse</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LoginRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">LoginMemberDto</span> loginMember <span class=\"token operator\">=</span> authService<span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> accessToken <span class=\"token operator\">=</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>loginMember<span class=\"token punctuation\">.</span><span class=\"token function\">memberId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">LoginResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">,</span> loginMember<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> authProvider<span class=\"token punctuation\">.</span><span class=\"token function\">provide</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthPayload</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Role</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMBER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LoginRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">OAuth2Client</span> oAuth2Client <span class=\"token operator\">=</span> oAuth2Clients<span class=\"token punctuation\">.</span><span class=\"token function\">getClient</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">socialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">accessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteMember</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        authService<span class=\"token punctuation\">.</span><span class=\"token function\">deleteMember</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/***/</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LoginMemberDto</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserInfo</span> userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findBySocialIdAndSocialType</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">socialId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">socialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LoginMemberDto</span><span class=\"token operator\">::</span><span class=\"token function\">isExists</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElseGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> <span class=\"token function\">signUp</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> <span class=\"token class-name\">LoginMemberDto</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNew</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Member</span> <span class=\"token function\">signUp</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserInfo</span> userInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">toMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">deleteMember</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> memberId<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NotFoundException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">MEMBER_NOT_FOUND</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>해당 PR 링크</h2>\n<p><a href=\"https://github.com/woowacourse-teams/2023-festa-go/pulls?q=is%3Apr+is%3Aclosed\">https://github.com/woowacourse-teams/2023-festa-go/pulls?q=is%3Apr+is%3Aclosed</a></p>","frontmatter":{"title":"Facade 객체를 활용해 트랜잭션에서 외부 API 통신 분리하기","date":"September 11, 2023","update":"September 11, 2023","tags":["Facade Pattern"],"series":null},"fields":{"slug":"/facade-service/","readingTime":{"minutes":2.515}}},"seriesList":{"edges":[{"node":{"id":"9ecb7f42-84ec-536a-9bfc-a3affcb87512","fields":{"slug":"/oauth2-select-and-apply/"},"frontmatter":{"title":"페스타고의 인증 - OAuth2를 선택하고 적용한 방법"}}},{"node":{"id":"1c28c731-cebd-5aab-b9bd-a5c397bf9c7a","fields":{"slug":"/oauth2-multiple-user-auth/"},"frontmatter":{"title":"페스타고의 인증 - 여러 사용자의 인증과 인가"}}},{"node":{"id":"b2e904f3-69c7-5c99-96e7-9555aaddc0e2","fields":{"slug":"/concurrency-redis/"},"frontmatter":{"title":"선착순 티켓팅에 Redis 도입하기"}}},{"node":{"id":"337eca9e-cd03-5e90-9d8f-d0b86e0ce4b9","fields":{"slug":"/facade-service/"},"frontmatter":{"title":"Facade 객체를 활용해 트랜잭션에서 외부 API 통신 분리하기"}}},{"node":{"id":"9ef33612-c159-552c-ba72-40903662c51c","fields":{"slug":"/event-singlelivedata/"},"frontmatter":{"title":"LiveData로 이벤트 처리하기: SingleLiveData"}}},{"node":{"id":"efd29a38-290b-5064-a87e-65f3d5ea4643","fields":{"slug":"/livedata-to-flow/"},"frontmatter":{"title":"Refactoring LiveData to Flow"}}}]},"previous":{"fields":{"slug":"/concurrency-redis/"},"frontmatter":{"title":"선착순 티켓팅에 Redis 도입하기"}},"next":{"fields":{"slug":"/event-singlelivedata/"},"frontmatter":{"title":"LiveData로 이벤트 처리하기: SingleLiveData"}}},"pageContext":{"id":"337eca9e-cd03-5e90-9d8f-d0b86e0ce4b9","series":null,"previousPostId":"b2e904f3-69c7-5c99-96e7-9555aaddc0e2","nextPostId":"9ef33612-c159-552c-ba72-40903662c51c"}},"staticQueryHashes":[],"slicesMap":{}}