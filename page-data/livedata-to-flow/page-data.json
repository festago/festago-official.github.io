{"componentChunkName":"component---src-templates-post-jsx","path":"/livedata-to-flow/","result":{"data":{"site":{"siteMetadata":{"title":"Festago"}},"markdownRemark":{"id":"efd29a38-290b-5064-a87e-65f3d5ea4643","excerpt":"안녕하세요. 페스타고의 베르입니다. 페스타고 앱을 개발하면서 LiveData 를 StateFlow 와 SharedFlow 로 리팩터링 했습니다. 리팩터링한 이유, 과정 그리고 어려웠던 점까지 공유하려고 합니다. Festago 를 개발하면서 ViewModel 의 UiState 및 Event 를 감지하기 위해 LiveData 를 사용했다.  이상적으로 Vie…","html":"<hr>\n<p>안녕하세요. 페스타고의 베르입니다.</p>\n<p>페스타고 앱을 개발하면서 LiveData 를 StateFlow 와 SharedFlow 로 리팩터링 했습니다. 리팩터링한 이유, 과정 그리고 어려웠던 점까지 공유하려고 합니다.</p>\n<hr>\n<p>Festago 를 개발하면서 ViewModel 의 UiState 및 Event 를 감지하기 위해 LiveData 를 사용했다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/f97d7/image.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 35.29411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABJElEQVR42q2QSW7DMAxFff+TdddNNkUQy9ZkTZ4aJbEdxL+kHBQ9QAUQFD6fPklVz+cGHwNiSkhDj851SH2PQJoPhz6MIzGRtIjYJ/TE+eApD/BUj+nQH8uC6rltkEri0ghoayC1gjIa1rmSG9mSpqmRI45qxNjOFq6RDZwn3SjiO+z7jmrb1vJQEcCPeELTdUULNAUbamtLM8NG1Fy0orDM8HZSS5o+gU+1rCviOGCg8XtaldeY57msxavzOjxtetcCfcM0TcCOMhHH63XkYriR4UoGebnh+sglvu/XkvPCdwrWl/zWbn9qxL3Z+/o4DJ0xOH9+4NR+oQkKtWtx1jXOtoag+6VrfkN4WTRmhCfO1LhYUWqmd4fhNWeo0WPKM/7j/ACuVhIVlixyDgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image' title='' src='/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/ca1dc/image.png' srcset='/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/e7570/image.png 170w,\n/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/f46e7/image.png 340w,\n/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/ca1dc/image.png 680w,\n/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/02d09/image.png 1020w,\n/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/9d567/image.png 1360w,\n/static/62ba8d1cfdcd4c1ebf6dedc09505ce1e/f97d7/image.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이상적으로 ViewModel 은 Android 를 알아선 안된다. 테스트 가능성, 메모리 누수 안전성, 모듈성을 향상시킨다.</p>\n<p>참고: AndroidDevelopers 블로그</p>\n<p><a href=\"https://medium.com/androiddevelopers/viewmodels-and-livedata-patterns-antipatterns-21efaef74a54\">https://medium.com/androiddevelopers/viewmodels-and-livedata-patterns-antipatterns-21efaef74a54</a></p>\n<p>이를 이유로 안드로이드 의존성을 갖는 LiveData 를 사용하던 기존 코드들을 Kotlin 의존성을 갖는 Flow 로 Migration 해보기로 했다.</p>\n<p>StateFlow 와 SharedFlow 에 대한 이론적인 글은 개인 블로그 글을 참고해주세요.</p>\n<p><a href=\"https://seonghoonc.tistory.com/30\">https://seonghoonc.tistory.com/30</a></p>\n<h2>화면 소개</h2>\n<p>Migration 할 학교 인증(StudentVerification)을 하는 화면이다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 383px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/af7906b3ca7d8be2e2dfde7b38b71096/c778f/image-1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 202.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAApCAYAAAA1bQl+AAAACXBIWXMAAAsTAAALEwEAmpwYAAAE5UlEQVR42qVWW2xURRje+AKlxvjgDU2UF6OJtwdfeDbGByVpMWiwDaEm1EAjUQPRBOEBNUWNIogojYquVgqRi+0uS/dCC15YmsrSGoqgsXS3l+1ut7vd3XbPbeZ8zsw5Z3fP6W5bcdOv/1y/+f+Z7585Ll3TQRks64Szn6gGNHX+PF52WQUnoZik2MHbdKIDuoFKTricDXxlVSmbiDKwuixRTM9QJNJUjC2PQHjoXMVYnSI3SxFLUkT+ofBdInD3UhzwUXzUpaP1pI6D3RSZHAWo4bktZCtE7kVnn4b6DwmebaVYvYNDx1O7gTXvA42fAq99A7zdAXzi1TE2RYUDVC0L2fKQh8kJ93k0uNYBL+6lOHFRwq6jKj74ScOhoIYjv6g43EPwY5jgveM6/owZhKQSoWYShgY11G7Q0fIlwdVYAd/2SvjCryAwoMB9TsWJsIYgG7PrGBC+RmyEtpA1M+SrUYL7W4xQmw9paPpMw+Y2wkKl2OYmePc4xZ5TFDs6dHh+Zx4SxymX64tvcDpL8cR2gppGYGUz8Pg24OndOhr2U+zsoGgL6PAxosFhKsZahLqT0GrUVIq32g2v2vwE/gjB9VGKmTwVfVwBlox0Oj8B5smG10HtEwWo0WdlSflBLChsEb45UTUzpFJq6lXStCLhzWJRQv0mSEt7yDa8aK1yFRDWL6CQYrlIqLFGaU6CKqtQJEVYVdZEWS7IFaGxfg6iEqOsaAaHpLKQGftsbg6TEwlkpmcQH08gOhzDXL7ATpadLymB1/li0RujGIuOY3RkDMn4FJszicKsBO6ciwgPZeQyOUGcz84ilZwWA2zhmZALilg4m8mLcVk2LzeTZ+Nlw0NOKDNCvjJvUM0QFFbmk5WCIqwos20Q+iSEHRgDMcoClDAHqHljE3tozjbKw2Xggt5z7C+8vPcSXj04gC0HLgs0749g6+eDGE8WKmdKpVPlyZKYlnBvQzce2OjDk1uDeKwlgEe3BPBQsx+uZ07C3z+5uLBLstLFoVy4ksJX3SNwB6NwB6L4jtnD3VF4wnEoMqlOWPUV5Kld5cffoSWFbHvEFMpyvDJ4FLZn1HmVVUO1N7uUeg6tESv9KoA4rA1W6nEdcis0yDbW0uB/gWRqmQmbiqxIJVPIprNIpzJiANedvkjo5eAJUswUzp5KpFhKZURaSSyNlkJIVeOQxGUsOwhLIWtLDpnfTFTTBMQtJW4b6wIou9sWA/eKv3aJVAGR6ykMDafx92jW0CFdQApVJcOzhv1NJOdwfjCO8FACQzcyYpvKvhyqC7Ya+LNKrXeZOF49LJBSS/mVnlHzi6H/Whqnfh2H92KcJfpEGZx1e1/nbxM4G0lClvn9xgi5Z6mMjIdfCeGW5zqxot6D5XUeYWuf92LFWg9uZbZ2rVG+bd1pYfmYGmssq//8x5Tw1MX/jU7O4ZHNPbhvQwCrmoJY2RjA6jfO482vL+P1tgg27evHTvcANn7ch9ajV1D3Thj3NPrF2FVNIdy5/gx8fXGTkHmYTEt4cBPzcE0XW82LZfVeYe96yYe7G87g9hdO4471PptdVudFDRuzvJ7Dg3MDSYPQuji5y+7gCDp6YzjSE8MPDN+HogLtZ5llF2l7KFas8zEdDO2s3nVhHJJEhDaLOvy/p8xlo9u/YCvobAltmgnr2+ZfxDzlbG9u7OwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image 1' title='' src='/static/af7906b3ca7d8be2e2dfde7b38b71096/c778f/image-1.png' srcset='/static/af7906b3ca7d8be2e2dfde7b38b71096/e7570/image-1.png 170w,\n/static/af7906b3ca7d8be2e2dfde7b38b71096/f46e7/image-1.png 340w,\n/static/af7906b3ca7d8be2e2dfde7b38b71096/c778f/image-1.png 383w' sizes='(max-width: 383px) 100vw, 383px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<ol>\n<li>Activity 를 시작하면 학교 ID 로 학교 이메일을 받아온다</li>\n<li>인증 번호 확인에 성공, 실패, 타임아웃 등 이벤트를 발생시킨다.</li>\n</ol>\n<h2>UiState LiveData to StateFlow</h2>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">sealed</span> <span class=\"token keyword\">interface</span> StudentVerificationUiState <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// 로딩 상태</span>\n    <span class=\"token keyword\">object</span> Loading <span class=\"token operator\">:</span> StudentVerificationUiState\n\n\t\t<span class=\"token comment\">// 성공 상태</span>\n    <span class=\"token keyword\">data</span> <span class=\"token keyword\">class</span> <span class=\"token function\">Success</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">val</span> schoolEmail<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">val</span> remainTime<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">val</span> isValidateCode<span class=\"token operator\">:</span> Boolean <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> StudentVerificationUiState\n\n\t\t<span class=\"token comment\">// 에러 상태</span>\n    <span class=\"token keyword\">object</span> Error <span class=\"token operator\">:</span> StudentVerificationUiState\n\n\t<span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>uiState 는 위와 같이 sealed interface 로 정의된다. 로딩, 성공, 실패 상태가 있으며 그에 따라 각각 다른 화면을 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">StudentsVerificationViewModel</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> schoolRepository<span class=\"token operator\">:</span> SchoolRepository<span class=\"token punctuation\">,</span>\n\t  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n\t\t<span class=\"token comment\">// 로딩 상태로 초기화</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> _uiState <span class=\"token operator\">=</span> MutableLiveData<span class=\"token operator\">&lt;</span>StudentVerificationUiState<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>StudentVerificationUiState<span class=\"token punctuation\">.</span>Loading<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> uiState<span class=\"token operator\">:</span> LiveData<span class=\"token operator\">&lt;</span>StudentVerificationUiState<span class=\"token operator\">></span> <span class=\"token operator\">=</span> _uiState\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">loadSchoolEmail</span><span class=\"token punctuation\">(</span>schoolId<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n        viewModelScope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n            schoolRepository<span class=\"token punctuation\">.</span><span class=\"token function\">loadSchoolEmail</span><span class=\"token punctuation\">(</span>schoolId<span class=\"token punctuation\">)</span>\n\t\t\t\t\t\t\t\t<span class=\"token comment\">// 성공하면 성공 상태로 set</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">onSuccess</span> <span class=\"token punctuation\">{</span> email <span class=\"token operator\">-></span>\n                    _uiState<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> StudentVerificationUiState<span class=\"token punctuation\">.</span><span class=\"token function\">Success</span><span class=\"token punctuation\">(</span>\n                        schoolEmail <span class=\"token operator\">=</span> email<span class=\"token punctuation\">,</span>\n                        remainTime <span class=\"token operator\">=</span> MIN_REMAIN_TIME<span class=\"token punctuation\">,</span>\n                    <span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n\t\t\t\t\t\t\t\t<span class=\"token comment\">// 실패하면 에러 상태로 set</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">onFailure</span> <span class=\"token punctuation\">{</span>\n                    _uiState<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> StudentVerificationUiState<span class=\"token punctuation\">.</span>Error\n                    <span class=\"token comment\">// ...</span>\n                <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이때 ViewModel 의 loadSchoolEmail() 을 호출하면 repository 로 학교 이메일을 요청하고 결과에 따라UiState 를 업데이트한다.</p>\n<p>이를 StateFlow 로 바꾸면?</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">StudentsVerificationViewModel</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> schoolRepository<span class=\"token operator\">:</span> SchoolRepository<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">ViewModel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 로딩 상태로 초기화 LiveData 와 달리 초기값이 필수다.</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> _uiState <span class=\"token operator\">=</span> MutableStateFlow<span class=\"token operator\">&lt;</span>StudentVerificationUiState<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>StudentVerificationUiState<span class=\"token punctuation\">.</span>Loading<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> uiState<span class=\"token operator\">:</span> StateFlow<span class=\"token operator\">&lt;</span>StudentVerificationUiState<span class=\"token operator\">></span> <span class=\"token operator\">=</span> _uiState<span class=\"token punctuation\">.</span><span class=\"token function\">asStateFlow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t</code></pre></div>\n<p>ViewModel 에서 코드는 거의 비슷하다! StateFlow 는 초기 값을 필수로 지정해줘야 한다. 그것 말고는 별 다른게 없다.</p>\n<p>Activity 에서는 다음과 같이 변경해야한다.</p>\n<ol>\n<li>observe 를 collect 로 변경한다.</li>\n<li>Lifecycle 변경을 감지할 수 있도록 처리한다.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">lifecycleScope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">repeatOnLifecycle</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">.</span>STARTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t\tviewModel<span class=\"token punctuation\">.</span>uiState<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span> <span class=\"token punctuation\">{</span> uiState <span class=\"token operator\">-></span>\n                <span class=\"token function\">handleUiState</span><span class=\"token punctuation\">(</span>uiState<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>stateFlow 는 LiveData 와 달리 알아서 LifeCycle 을 감지하지 못한다.</p>\n<p>홈 화면을 누르거나 다른 액티비티에 가리는 등 생명주기가 Stopped 상태일 때 계속해서 collect 하고 있지 않도록 repeatOnLifecycle 을 사용해 처리했다.</p>\n<p>이 과정에서 ViewModel 테스트는 어떻게 되었을까?</p>\n<h3>ViewModel Test with LiveData</h3>\n<p>기존 LiveData 사용 시 테스트다. 테스트에 관한 자세한 얘기는 생략하겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@get:Rule</span>\n<span class=\"token keyword\">val</span> instantExecutorRule <span class=\"token operator\">=</span> <span class=\"token function\">InstantTaskExecutorRule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token annotation builtin\">@Test</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">`이메일 불러오기에 실패하면 실패 상태가 된다`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// given</span>\n    <span class=\"token function\">`이메일 요청 결과가 다음과 같을 때`</span><span class=\"token punctuation\">(</span>Result<span class=\"token punctuation\">.</span><span class=\"token function\">failure</span><span class=\"token punctuation\">(</span><span class=\"token function\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// when</span>\n    viewModel<span class=\"token punctuation\">.</span><span class=\"token function\">loadSchoolEmail</span><span class=\"token punctuation\">(</span>schoolId<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// then : </span>\n    <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>viewModel<span class=\"token punctuation\">.</span>uiState<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isExactlyInstanceOf</span><span class=\"token punctuation\">(</span>StudentVerificationUiState<span class=\"token punctuation\">.</span>Error<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">.</span>java<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ViewModel 의 uiState 의 value 가져와 검증한다.</p>\n<p>안드로이드 의존성을 갖는 LiveData 를 ViewModel 에서 사용하면 ViewModel 을 단위 테스트하기 위해 Rule을 추가해줘야 한다.</p>\n<h3>ViewModel Test with StateFlow</h3>\n<p>테스트를 짜다보면 리팩터링 할 때 기존 테스트코드에 빨간줄이 생기는 경험을 하게된다. 하지만 이 경우엔 없다!</p>\n<p>value 로 뽑아서 가져오는 방식이 LiveData 와 똑같기 때문이다.</p>\n<p><strong>더 이상 사용하지 않는 Rule 만 제거해주면 된다.</strong></p>\n<h2>Event 처리 LiveData to SharedFlow</h2>\n<p>Event Wrapping class 를 사용한 커스텀 SingleLiveData 를 사용하고 있었다.</p>\n<p>그 이유는 다음 글로 확인하길 바란다.</p>\n<p><a href=\"https://festago.github.io/event-singlelivedata/\">https://festago.github.io/event-singlelivedata/</a></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> _event <span class=\"token operator\">=</span> MutableSingleLiveData<span class=\"token operator\">&lt;</span>StudentVerificationEvent<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> event<span class=\"token operator\">:</span> SingleLiveData<span class=\"token operator\">&lt;</span>StudentVerificationEvent<span class=\"token operator\">></span> <span class=\"token operator\">=</span> _event\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">confirmVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    viewModelScope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n        studentVerificationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">requestVerificationCodeConfirm</span><span class=\"token punctuation\">(</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">onSuccess</span> <span class=\"token punctuation\">{</span>\n                _event<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>StudentVerificationEvent<span class=\"token punctuation\">.</span>VerificationSuccess<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">onFailure</span> <span class=\"token punctuation\">{</span>\n            _event<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>StudentVerificationEvent<span class=\"token punctuation\">.</span>VerificationFailure<span class=\"token punctuation\">)</span>\n         <span class=\"token punctuation\">}</span>\n     <span class=\"token punctuation\">}</span></code></pre></div>\n<p>발생시키고 싶은 Event 가 있다면 MutableSingleLiveData 의 value 를 set 하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> _event <span class=\"token operator\">=</span> MutableSharedFlow<span class=\"token operator\">&lt;</span>StudentVerificationEvent<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> event<span class=\"token operator\">:</span> SharedFlow<span class=\"token operator\">&lt;</span>StudentVerificationEvent<span class=\"token operator\">></span> <span class=\"token operator\">=</span> _event<span class=\"token punctuation\">.</span><span class=\"token function\">asSharedFlow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">confirmVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\tviewModelScope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n\t      studentVerificationRepository<span class=\"token punctuation\">.</span><span class=\"token function\">requestVerificationCodeConfirm</span><span class=\"token punctuation\">(</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">.</span><span class=\"token function\">onSuccess</span> <span class=\"token punctuation\">{</span>\n            _event<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>StudentVerificationEvent<span class=\"token punctuation\">.</span>VerificationSuccess<span class=\"token punctuation\">)</span>\n         <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">onFailure</span> <span class=\"token punctuation\">{</span>\n            _event<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>StudentVerificationEvent<span class=\"token punctuation\">.</span>VerificationFailure<span class=\"token punctuation\">)</span>\n         <span class=\"token punctuation\">}</span>\n     <span class=\"token punctuation\">}</span></code></pre></div>\n<p>하지만 sharedFlow 는 value 를 사용하지 않는다. 발생시키고 싶은 Event 가 있다면 emit 을 해주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">lifecycleScope<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">repeatOnLifecycle</span><span class=\"token punctuation\">(</span>Lifecycle<span class=\"token punctuation\">.</span>State<span class=\"token punctuation\">.</span>STARTED<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            viewModel<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span> <span class=\"token punctuation\">{</span> event <span class=\"token operator\">-></span>\n                <span class=\"token function\">handleEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>event 도 마찬가지로 Lifecycle 에 맞춰 동작하기 위해 위와 같은 이유로 repeatOnLifecycle 을 적용했다.</p>\n<p>여기까진 아무 문제가 없었다. 하지만 테스트에서 몇가지 문제가 발생했다.</p>\n<h3>ViewModelTest with SharedFlow</h3>\n<p><strong>문제점 1.  sharedFlow 는 getValue() 로 값을 얻어올 수 없다.</strong></p>\n<p>sharedFlow 는 LiveData 혹은 StateFlow 와 다르게 value 를 가져올 수 없다.  그렇기 때문에 방출되는 값을 반환받을 방법이 필요했다.</p>\n<p>해결 방법 : Flow 의 first() 확장함수 사용</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f0adc435f0c72d9a01c507f44dd7912d/89e0a/image-2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 37.64705882352941%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABGklEQVR42o2QWW7DMAxEfR1tFLXZTp2kKfrT+19oOpacFElRoB8PQ9PiSJxJZ4XOlRTEljtalSokIlF1johFfqFVIDlQI4IGOOswZRrmtpIFSk3LRhbUVdFOGWlNfcAH/4w81y44OEfDjTd8vM3YWsLcGlYaVprXJFiK8rDC+XH7A/d3Pc3LitvnF07blUYzJEj/aQ/8PuD8GPwHU5SA27ag5AyRSBML69xQazrGDMb3uMi96L2ekjLDpAjMIniGTVMNFns/5UKYYyq91v1cDAOeFz4mML9Ald4LmM4M/HK5Yju/Y2WGKWUUMail9Ah2Sm2HVkSVzm4QdRhJZC9J18k703PSmPhCB8NVDZ9+X/OVEYU9VrTHuj+9b6tM9vjHcgXHAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image 2' title='' src='/static/f0adc435f0c72d9a01c507f44dd7912d/ca1dc/image-2.png' srcset='/static/f0adc435f0c72d9a01c507f44dd7912d/e7570/image-2.png 170w,\n/static/f0adc435f0c72d9a01c507f44dd7912d/f46e7/image-2.png 340w,\n/static/f0adc435f0c72d9a01c507f44dd7912d/ca1dc/image-2.png 680w,\n/static/f0adc435f0c72d9a01c507f44dd7912d/02d09/image-2.png 1020w,\n/static/f0adc435f0c72d9a01c507f44dd7912d/89e0a/image-2.png 1355w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>first 의 내부 구조를 보면 알 수 있듯  이 함수는 방출되는 가장 첫번째 값을 반환하며 일정 시간동안 방출되지 않으면 NoSuchElementException() 을 발생시킨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Test</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">`... 인증 번호 확인이 성공하면 인증 성공 이벤트가 발생한다`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runTest <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token comment\">// ...</span>\n\n        <span class=\"token comment\">// when</span>\n        viewModel<span class=\"token punctuation\">.</span><span class=\"token function\">confirmVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>vm<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>StudentVerificationEvent<span class=\"token punctuation\">.</span>VerificationSuccess<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>flow 는 코루틴 위에서 동작한다. 따라서 suspend function 인 first() 를 사용하려면 runTest 를 사용해 TestScope 를 열어줘야 한다.</p>\n<p>하지만 이것은 곧바로 다음 문제를 직면한다.</p>\n<p><strong>문제점 2. sharedFlow 가 값을 방출할 때 까지 기다리지 않는다.</strong></p>\n<p>이전의 코드는 처음으로 방출된 event 를 받아오지만 viewModel.confirmVerificationCode() 와 vm.event.first() 가 동기적으로 실행된다. 실제로 방출된 이후 값을 기다리게 되어 기다리기만 하다가 결국 예외가 발생한다.</p>\n<p>값이 들어올 때 까지 기다리게 하기 위해서 async scope 를 열고 값이 반환된 후에 assertThat 검증이 실행되도록 변경하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Test</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">`given ... 인증 번호 확인이 성공하면 인증 성공 이벤트가 발생한다`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">runTest</span><span class=\"token punctuation\">(</span><span class=\"token function\">UnConfinedTestDispather</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token comment\">// ...</span>\n\n        <span class=\"token comment\">// sharedFlow Event 기다리기</span>\n        <span class=\"token keyword\">val</span> deferredEvent <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n            vm<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// when</span>\n        viewModel<span class=\"token punctuation\">.</span><span class=\"token function\">confirmVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>deferredEvent<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 하면 처음으로 방출되는 이벤트가 반환될 때까지 기다렸다가 검증하여 테스트가 정상적으로 작동한다.</p>\n<p>이때 주의할 점은 테스트의 즉각적인 실행을 위해 UnConfinedTestDispatcher 를 사용해야 한다.</p>\n<ul>\n<li>UnConfinedTesDispatcher : 코루틴 빌더가 반환될 때까지 기다리지 않고 즉시 실행해 예상 가능한 결과를 테스트할 수 있다.</li>\n</ul>\n<p>테스트의 정상 작동은 확인했지만 그래도 아직 마음에 들지 않는다.</p>\n<p><strong>문제점3. 테스트는 편리해야 한다.</strong></p>\n<p>매번 deferred  type 으로 기다리게 하고 await 으로 값을 체크하는 것은 용납할 수 없는 불편함이다. 그러다 찾은 것이 바로 turbine 이다.</p>\n<p>turbine 은 Flow Test third-party 라이브러리로 공식문서에서 편리한 Flow 테스트를 위해 사용해라고 소개되어있다.</p>\n<p><a href=\"https://developer.android.com/kotlin/flow/test\">https://developer.android.com/kotlin/flow/test</a></p>\n<p><a href=\"https://github.com/cashapp/turbine\">https://github.com/cashapp/turbine</a></p>\n<p>이 turbine 라이브러리를 사용하면 turbine 스코프를 열 수 있는데 이를 사용하면 훨씬 간단하게 위의 테스트를 진행할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Test</span>\n<span class=\"token keyword\">fun</span> <span class=\"token function\">`... 인증 번호 확인이 성공하면 인증 성공 이벤트가 발생한다`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runTest <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// given</span>\n        <span class=\"token operator\">..</span><span class=\"token punctuation\">.</span>\n\n\t\t\t\t<span class=\"token operator\">*</span><span class=\"token operator\">*</span>vm<span class=\"token punctuation\">.</span>event<span class=\"token punctuation\">.</span><span class=\"token function\">test</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// turbineScope**</span>\n        \n        <span class=\"token comment\">// when</span>\n\t\t\t\tviewModel<span class=\"token punctuation\">.</span><span class=\"token function\">confirmVerificationCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">*</span><span class=\"token operator\">*</span>            <span class=\"token comment\">// then</span>\n            <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span><span class=\"token function\">awaitItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token operator\">..</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n            <span class=\"token function\">cancelAndIgnoreRemainingEvents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>test turbine 스코프 내에서 awaitItem() 을 사용할 때마다 방출되는 값을 받을 수 있고 cancelAndIgnoreRemainingEvents() 를 사용해  남은 이벤트를 받지 않고 코루틴 스코프를 cancel 할 수 있다.</p>\n<p>아무 이벤트도 일어나지 않음을 테스트하려면 <code class=\"language-text\">expectNoEvents() 를 사용하면 된다.</code></p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/168b249943126bfcfa718cfc01b1118e/f97d7/image-3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 13.529411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAo0lEQVR42i2O2wqDMBBE/f+Pa1FjYjS9mXsspdCHQq1Md0MfhpmdZdnTeB+QcoEldyTrHEJMtQshVkWaufchoKwr7SMu1xtKKTU755FSxrJYNKOe0A8SbS/QkQ7Hts5q1BDkYlB/lxikon4E3wipIacTOqFgzBl6mjEbgyYmpsn1O38pZUUmOs684z4TCfeWSDhX8vsL9vFBeb6x719s20a+4wd28dtE/TzKHAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image 3' title='' src='/static/168b249943126bfcfa718cfc01b1118e/ca1dc/image-3.png' srcset='/static/168b249943126bfcfa718cfc01b1118e/e7570/image-3.png 170w,\n/static/168b249943126bfcfa718cfc01b1118e/f46e7/image-3.png 340w,\n/static/168b249943126bfcfa718cfc01b1118e/ca1dc/image-3.png 680w,\n/static/168b249943126bfcfa718cfc01b1118e/02d09/image-3.png 1020w,\n/static/168b249943126bfcfa718cfc01b1118e/9d567/image-3.png 1360w,\n/static/168b249943126bfcfa718cfc01b1118e/f97d7/image-3.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>추가적으로 Turbine 은 UnconfinedTestDispatcher 에 의존하고 있다. 이는 테스트를 더 쉽게 만들지만 이를 인지하고 사용해야 한다.</p>\n<p>다음은 학습을 위해 작성한 테스트 코드이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> SharedFlowTest <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> _sharedFlow <span class=\"token operator\">=</span> MutableSharedFlow<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>replay <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> sharedFlow <span class=\"token operator\">=</span> _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">asSharedFlow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// 실패</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">`test sharedFlow in StandardTestDispatcher`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runTest <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// when</span>\n        _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 실패</span>\n    <span class=\"token annotation builtin\">@OptIn</span><span class=\"token punctuation\">(</span>ExperimentalCoroutinesApi<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">`test sharedFlow in UnconfinedTestDispatcher`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">runTest</span><span class=\"token punctuation\">(</span><span class=\"token function\">UnconfinedTestDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// when</span>\n        _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 실패</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">`test sharedFlow with async in StandardTestDispatcher`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runTest <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> deferred <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n            sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// when</span>\n        _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>deferred<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 성공</span>\n    <span class=\"token annotation builtin\">@OptIn</span><span class=\"token punctuation\">(</span>ExperimentalCoroutinesApi<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">`test sharedFlow with async in UnconfinedTestDispatcher`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">runTest</span><span class=\"token punctuation\">(</span><span class=\"token function\">UnconfinedTestDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> deferred <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n            sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token comment\">// when</span>\n        _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// then</span>\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>deferred<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 성공</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">`test sharedFlow with turbine in StandardTestDispatcher`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runTest <span class=\"token punctuation\">{</span>\n        sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">test</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// when</span>\n            _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token comment\">// then</span>\n            <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span><span class=\"token function\">awaitItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token comment\">// 성공</span>\n    <span class=\"token annotation builtin\">@OptIn</span><span class=\"token punctuation\">(</span>ExperimentalCoroutinesApi<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation builtin\">@Test</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">`test sharedFlow with turbine in UnconfinedTestDispatcher`</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">runTest</span><span class=\"token punctuation\">(</span><span class=\"token function\">UnconfinedTestDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">test</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// when</span>\n            _sharedFlow<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token comment\">// then</span>\n            <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span><span class=\"token function\">awaitItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 결과를 확인하면 더 쉽게 이해할 수 있을 것이다.</p>\n<h2>해당 PR 링크</h2>\n<p><a href=\"https://github.com/woowacourse-teams/2023-festa-go/pull/429\">https://github.com/woowacourse-teams/2023-festa-go/pull/429</a></p>\n<h3>다른 화면 리팩터링</h3>\n<p><a href=\"https://github.com/woowacourse-teams/2023-festa-go/pull/493\">https://github.com/woowacourse-teams/2023-festa-go/pull/493</a>\n<a href=\"https://github.com/woowacourse-teams/2023-festa-go/pull/494\">https://github.com/woowacourse-teams/2023-festa-go/pull/494</a>\n<a href=\"https://github.com/woowacourse-teams/2023-festa-go/pull/495\">https://github.com/woowacourse-teams/2023-festa-go/pull/495</a></p>","frontmatter":{"title":"Refactoring LiveData to Flow","date":"October 11, 2023","update":"October 11, 2023","tags":["Android","LiveData","Flow","StateFlow","SharedFlow","Test"],"series":null},"fields":{"slug":"/livedata-to-flow/","readingTime":{"minutes":11.25}}},"seriesList":{"edges":[{"node":{"id":"9ecb7f42-84ec-536a-9bfc-a3affcb87512","fields":{"slug":"/oauth2-select-and-apply/"},"frontmatter":{"title":"페스타고의 인증 - OAuth2를 선택하고 적용한 방법"}}},{"node":{"id":"1c28c731-cebd-5aab-b9bd-a5c397bf9c7a","fields":{"slug":"/oauth2-multiple-user-auth/"},"frontmatter":{"title":"페스타고의 인증 - 여러 사용자의 인증과 인가"}}},{"node":{"id":"b2e904f3-69c7-5c99-96e7-9555aaddc0e2","fields":{"slug":"/concurrency-redis/"},"frontmatter":{"title":"선착순 티켓팅에 Redis 도입하기"}}},{"node":{"id":"337eca9e-cd03-5e90-9d8f-d0b86e0ce4b9","fields":{"slug":"/facade-service/"},"frontmatter":{"title":"Facade 객체를 활용해 트랜잭션에서 외부 API 통신 분리하기"}}},{"node":{"id":"9ef33612-c159-552c-ba72-40903662c51c","fields":{"slug":"/event-singlelivedata/"},"frontmatter":{"title":"LiveData로 이벤트 처리하기: SingleLiveData"}}},{"node":{"id":"efd29a38-290b-5064-a87e-65f3d5ea4643","fields":{"slug":"/livedata-to-flow/"},"frontmatter":{"title":"Refactoring LiveData to Flow"}}}]},"previous":{"fields":{"slug":"/event-singlelivedata/"},"frontmatter":{"title":"LiveData로 이벤트 처리하기: SingleLiveData"}},"next":null},"pageContext":{"id":"efd29a38-290b-5064-a87e-65f3d5ea4643","series":null,"previousPostId":"9ef33612-c159-552c-ba72-40903662c51c","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}