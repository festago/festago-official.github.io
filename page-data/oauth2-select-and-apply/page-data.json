{"componentChunkName":"component---src-templates-post-jsx","path":"/oauth2-select-and-apply/","result":{"data":{"site":{"siteMetadata":{"title":"Festago"}},"markdownRemark":{"id":"9ecb7f42-84ec-536a-9bfc-a3affcb87512","excerpt":"서론 안녕하세요. 페스타고의 글렌입니다. 🥃 페스타고는 인증을 구현할 때, 최소한의 정보로 안전하게 인증을 구현할 수 있는 OAuth2를 채택하였습니다. OAuth2를 구현할 때 서비스를 제공하는 회사들은 매우 많습니다. 그중에서 저희가 선택한 OAuth2 제공자는  입니다. 카카오톡을 선택한 이유는 저희 서비스의 특성상 사용자 간의 티켓 거래를 막기 위…","html":"<h2>서론</h2>\n<p>안녕하세요.</p>\n<p>페스타고의 글렌입니다. 🥃</p>\n<p>페스타고는 인증을 구현할 때, 최소한의 정보로 안전하게 인증을 구현할 수 있는 OAuth2를 채택하였습니다.</p>\n<p>OAuth2를 구현할 때 서비스를 제공하는 회사들은 매우 많습니다.</p>\n<p>그중에서 저희가 선택한 OAuth2 제공자는 <code class=\"language-text\">카카오톡</code> 입니다.</p>\n<p>카카오톡을 선택한 이유는 저희 서비스의 특성상 사용자 간의 티켓 거래를 막기 위함인데요.</p>\n<p>구글이나 페이스북 등 쉽게 계정을 생성할 수 있는 서비스는 한 명의 사용자가 여러 계정을 통해 티켓을 예매할 수 있으므로, 국내에서 유일한 전화번호로 계정을 생성할 수 있는 서비스 제공자인 카카오톡을 선택하게 되었습니다.</p>\n<p>페스타고에서 구현한 OAuth2의 인증 플로우는 다음과 같습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/83a6a914cae127d31cb921cf481a572a/ac7a9/20230819155223.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABi0lEQVR42l1SW3KjMBD0/U+QS+whkp+tWr+JSQwSoAiQBbgc4bWJ0IvVY2O7Mh9iRnSrumdmNvkQUhpjpv9hRv1lz1BoLSQ/Tw8xjFJ78ExrbT/PL89d14V/F37+lTwN4yWU7FSTYu6e9AQh5O8IDl/ckQMiy3PW9zbhnCNU7NOYUiqEMEYnSbJYrq/Xa0AeCFksl3meO3IQdxoUO1+Oxw4AgD7wW5pDAOI4bijFNaHMqbjZYFxzoe5kxg2XumloXVVVTaI9hBBAd4AUQICqA6lxWTZt68DjJJzXb9m2lnrSSkkpD7R53YMsy4qiQAglKYzeQds00scNfCf337VVp8yUk+MHKsqyJKROs9zKNlpJpexQlBT9DzJ7IFsjBT1F2+1ms4l3u2gXr3fvr9F2tVr/mc9XizmoWm/W3Mm2B1a11W2TAxt69mmVY4wRLiGubS+sBWvkzD7bv6P07FmYXtn1UfyW+RbZBB9731c/WO2eDt0O4J8N40K6JdMulNZS37bNcZR5XDBXhot/telv4az6RtoAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='20230819155223' title='' src='/static/83a6a914cae127d31cb921cf481a572a/ca1dc/20230819155223.png' srcset='/static/83a6a914cae127d31cb921cf481a572a/e7570/20230819155223.png 170w,\n/static/83a6a914cae127d31cb921cf481a572a/f46e7/20230819155223.png 340w,\n/static/83a6a914cae127d31cb921cf481a572a/ca1dc/20230819155223.png 680w,\n/static/83a6a914cae127d31cb921cf481a572a/02d09/20230819155223.png 1020w,\n/static/83a6a914cae127d31cb921cf481a572a/9d567/20230819155223.png 1360w,\n/static/83a6a914cae127d31cb921cf481a572a/ac7a9/20230819155223.png 1920w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이 방식은 <code class=\"language-text\">Authorization Code Grant Type</code>라고 불리는 OAuth2 인증 방식의 종류 중 하나입니다.</p>\n<p>해당 인증 방식은 사용자는 신뢰할 수 있는 OAuth2 인증 서버로 요청을 보내고, 인증 서버는 클라이언트(백엔드 스프링 서버)에 엑세스 토큰과 사용자 정보를 반환합니다.</p>\n<p>이러한 방식으로 사용자의 엑세스 토큰과 사용자 정보의 노출을 최소화할 수 있으므로 보안의 신뢰성이 높습니다.</p>\n<p>이러한 방식을 어떻게 코드로 구현하였는지 설명하겠습니다.</p>\n<p>코드로 구현할 클래스를 간략히 나타낸다면 한다면 다음과 같습니다.</p>\n<p><code class=\"language-text\">SocialType</code>: Enum으로 OAuth2의 제공자를 나타냅니다. (ex: KAKAO)</p>\n<p><code class=\"language-text\">AuthProvider</code>: 사용자 정보를 바탕으로 저희의 엑세스 토큰을 만들어 주는 역할을 합니다.</p>\n<p><code class=\"language-text\">AuthExtractor</code>: 엑세스 토큰을 파싱하여 유효성을 검증하고 Payload의 값을 추출하는 역할을 합니다.</p>\n<p><code class=\"language-text\">OAuth2Client</code>: OAuth2 인증, 리소스 서버로 요청을 보내고 엑세스 토큰, 사용자 정보 등 민감한 정보를 받는 역할을 합니다.</p>\n<p><code class=\"language-text\">Member</code>: 사용자의 정보를 담고 있는 엔티티로, <code class=\"language-text\">SocialType</code>을 필드로 가지고 있습니다.</p>\n<p><code class=\"language-text\">AuthService</code>: 인증을 수행하는 서비스 레이어 클래스입니다.</p>\n<p>여기서 <code class=\"language-text\">OAuth2Client</code>는 외부 API에 의존하므로, 인터페이스로 만들어 테스트나 로컬 환경에서 모의 객체를 만들 수 있도록 하였습니다.</p>\n<h4>AuthProvider</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtAuthProvider</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AuthProvider</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">SECOND_FACTOR</span> <span class=\"token operator\">=</span> <span class=\"token number\">60</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">int</span> <span class=\"token constant\">MILLISECOND_FACTOR</span> <span class=\"token operator\">=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MEMBER_ID_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"memberId\"</span><span class=\"token punctuation\">;</span>\n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">SecretKey</span> key<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> expirationMinutes<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">JwtAuthProvider</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> secretKey<span class=\"token punctuation\">,</span> <span class=\"token keyword\">long</span> expirationMinutes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>key <span class=\"token operator\">=</span> <span class=\"token class-name\">Keys</span><span class=\"token punctuation\">.</span><span class=\"token function\">hmacShaKeyFor</span><span class=\"token punctuation\">(</span>secretKey<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>expirationMinutes <span class=\"token operator\">=</span> expirationMinutes<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">provide</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AuthPayload</span> authPayload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">Date</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">claim</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_ID_KEY</span><span class=\"token punctuation\">,</span> authPayload<span class=\"token punctuation\">.</span><span class=\"token function\">getMemberId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>   \n            <span class=\"token punctuation\">.</span><span class=\"token function\">setIssuedAt</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">setExpiration</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> expirationMinutes <span class=\"token operator\">*</span> <span class=\"token constant\">SECOND_FACTOR</span> <span class=\"token operator\">*</span> <span class=\"token constant\">MILLISECOND_FACTOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">signWith</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SignatureAlgorithm</span><span class=\"token punctuation\">.</span><span class=\"token constant\">HS256</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">compact</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>AuthProvider의 구현체인 <code class=\"language-text\">JwtAuthProvider</code> 입니다.</p>\n<p><code class=\"language-text\">Member</code> 엔티티의 PK를 Payload에 넣어 JWT 토큰을 반환해 줍니다.</p>\n<p>해당 토큰은 앞으로 저희 서버에 인증 과정에 필요한 엑세스 토큰입니다.</p>\n<h4>AuthExtractor</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">JwtAuthExtractor</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">AuthExtractor</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MEMBER_ID_KEY</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"memberId\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">JwtParser</span> jwtParser<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">JwtAuthExtractor</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> secretKey<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">SecretKey</span> key <span class=\"token operator\">=</span> <span class=\"token class-name\">Keys</span><span class=\"token punctuation\">.</span><span class=\"token function\">hmacShaKeyFor</span><span class=\"token punctuation\">(</span>secretKey<span class=\"token punctuation\">.</span><span class=\"token function\">getBytes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>jwtParser <span class=\"token operator\">=</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">parserBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">setSigningKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthPayload</span> <span class=\"token function\">extract</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">Claims</span> claims <span class=\"token operator\">=</span> <span class=\"token function\">getClaims</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token class-name\">Long</span> memberId <span class=\"token operator\">=</span> claims<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_ID_KEY</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AuthPayload</span><span class=\"token punctuation\">(</span>memberId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Claims</span> <span class=\"token function\">getClaims</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">return</span> jwtParser<span class=\"token punctuation\">.</span><span class=\"token function\">parseClaimsJws</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>  \n                <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">ExpiredJwtException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnauthorizedException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">EXPIRED_AUTH_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JwtException</span> <span class=\"token operator\">|</span> <span class=\"token class-name\">IllegalArgumentException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UnauthorizedException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INVALID_AUTH_TOKEN</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>AuthExtractor의 구현체인 <code class=\"language-text\">JwtAuthExtractor</code> 입니다.</p>\n<p>토큰을 받아 <code class=\"language-text\">AuthPayload</code> 객체로 만들어 반환합니다.</p>\n<p>참고로 필드로 <code class=\"language-text\">JwtParser</code>를 가지고 있는데 이는 <code class=\"language-text\">Jwts.parserBuilder()</code> 메소드로 생성된 인스턴스는 불변하고, thread-safe 하기 때문입니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/506e688f9113a93787b0ba4a5a32dff0/b9f8c/20230818023037.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 20.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqElEQVR42m2PWQ7DIAxEc56w2Kw2iVr1/peaGoL61Y8nhsWjx8GNUO6EpMW4wfoBtwYqwYgPlX7ZRw8fPJxzfzkozUFCEkUsRkqgHG0NC85h7WnvY7I7DvDeSk/3sMvOWSjs0A21h713yLig40bXC7cUvDTjPTKG0LJbw1YWzDJsW7/zPDtmmIXFCmtX1CboZttEUGsBMy07tl9wntlsOT6rwdM+70weX5WBfNTKQKa8AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='20230818023037' title='' src='/static/506e688f9113a93787b0ba4a5a32dff0/ca1dc/20230818023037.png' srcset='/static/506e688f9113a93787b0ba4a5a32dff0/e7570/20230818023037.png 170w,\n/static/506e688f9113a93787b0ba4a5a32dff0/f46e7/20230818023037.png 340w,\n/static/506e688f9113a93787b0ba4a5a32dff0/ca1dc/20230818023037.png 680w,\n/static/506e688f9113a93787b0ba4a5a32dff0/b9f8c/20230818023037.png 854w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>따라서 다음과 같이 파싱할 때마다 인스턴스를 새롭게 만들지 않고, 기존의 인스턴스를 재사용할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 파싱마다 새로운 인스턴스 생성</span>\n<span class=\"token keyword\">return</span> <span class=\"token class-name\">Jwts</span><span class=\"token punctuation\">.</span><span class=\"token function\">parserBuilder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">setSigningKey</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">parseClaimsJws</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 파싱마다 기존의 인스턴스 재사용</span>\n<span class=\"token keyword\">return</span> jwtParser<span class=\"token punctuation\">.</span><span class=\"token function\">parseClaimsJws</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>  \n                <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  </code></pre></div>\n<h4>OAuth2Client</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2Client</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuth2Client</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">ACCESS_TOKEN_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://kauth.kakao.com/oauth/token\"</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">USER_INFO_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://kapi.kakao.com/v2/user/me\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> redirectId<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoOAuth2Client</span><span class=\"token punctuation\">(</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.grant-type}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.client-id}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.redirect-uri}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">,</span>  \n        <span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder  \n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grantType <span class=\"token operator\">=</span> grantType<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientId <span class=\"token operator\">=</span> clientId<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redirectId <span class=\"token operator\">=</span> redirectUri<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">,</span> grantType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">,</span> clientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">,</span> redirectId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoAccessTokenResponse</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span>  \n                <span class=\"token constant\">ACCESS_TOKEN_URL</span><span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">,</span>  \n                <span class=\"token class-name\">KakaoAccessTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">accessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClientErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoOAuth2Error</span> kakaoOAuth2Error <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getResponseBodyAs</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KakaoOAuth2Error</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>kakaoOAuth2Error<span class=\"token punctuation\">.</span><span class=\"token function\">isErrorCodeKOE320</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_INVALID_CODE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setBearerAuth</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoUserInfo</span> kakaoUserInfo <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_INFO_URL</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n                    <span class=\"token class-name\">KakaoUserInfo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>  \n                <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofKakao</span><span class=\"token punctuation\">(</span>kakaoUserInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClientErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">KakaoOAuth2Error</span><span class=\"token punctuation\">(</span>  \n        <span class=\"token class-name\">String</span> error<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@JsonProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error_description\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> errorDescription<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@JsonProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error_code\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> errorCode  \n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  \n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isErrorCodeKOE320</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">return</span> errorCode<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"KOE320\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>실제 카카오 OAuth2 서비스 제공자에게 정보를 요청하는 <code class=\"language-text\">KakaoOAuth2Client</code> 입니다.</p>\n<p>코드에 지저분한 곳이 많고, 단일 책임 원칙을 지키지 않는 부분이 있습니다. (액세스 토큰 요청, 사용자 정보 요청)</p>\n<p>추후 이 부분을 어떻게 개선했는지 알려드리겠습니다.</p>\n<blockquote>\n<p>record에 @JsonProperty를 사용한 이유는 <a href=\"https://stackoverflow.com/questions/68394911/why-record-class-cant-be-properly-deserialized-with-jackson\">스택 오버플로우 링크</a>에 나와 있습니다.</p>\n</blockquote>\n<h4>AuthService</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuth2Client</span> oAuth2Client<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthProvider</span> authProvider<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2Client</span> oAuth2Client<span class=\"token punctuation\">,</span> <span class=\"token class-name\">AuthProvider</span> authProvider<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>memberRepository <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oAuth2Client <span class=\"token operator\">=</span> oAuth2Client<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>authProvider <span class=\"token operator\">=</span> authProvider<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LoginResponse</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">String</span> accessToken <span class=\"token operator\">=</span> oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token class-name\">UserInfo</span> userInfo <span class=\"token operator\">=</span> oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findBySocialIdAndSocialType</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">socialId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">socialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElseGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">toMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LoginResponse</span><span class=\"token punctuation\">(</span>authProvider<span class=\"token punctuation\">.</span><span class=\"token function\">provide</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">nickname</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>컨트롤러에서 보내온 요청을 처리하는 서비스 클래스입니다.</p>\n<p>흐름은 맨 위에서 설명한 것과 같이 코드를 받아, OAuth2 서비스 제공자로부터 액세스 토큰을 얻고, 사용자 정보를 얻은 뒤 기존의 회원이 있으면 <code class=\"language-text\">AuthProvider</code>를 통해 액세스 토큰을 반환하고, 기존의 회원이 없다면 <code class=\"language-text\">orElseGet()</code> 메서드를 통해 회원을 생성하고 액세스 토큰을 반환합니다.</p>\n<hr>\n<p>이렇게 구현한 방식에는 문제점이 있습니다.</p>\n<p><code class=\"language-text\">OAuth2Client</code>의 코드를 보면 단일 책임 원칙을 지키지 못했고(액세스 코드와 사용자 정보를 모두 관리) 요청을 보낼 때 예외를 처리하기 위한 try-catch문 때문에 코드의 가독성이 나쁩니다.</p>\n<p>그리고 <code class=\"language-text\">OAuth2Client</code>를 인터페이스로 정의하여 변경에는 유연하게 대응했지만, 단일 인스턴스이기 때문에 다른 OAuth2 서비스 제공자가 추가될 경우 새로운 클래스 혹은 메소드가 필요합니다.</p>\n<h3>단일 책임 원칙의 분리</h3>\n<p>유명한 객체 지향 원칙인 SOLID 원칙에서 S는 단일 책임 원칙을 뜻합니다.</p>\n<p>스프링 프레임워크를 사용하며, 의존성 주입을 통한 OCP, DIP 원칙은 매우 쉽게 지킬 수 있으나, SRP 원칙은 구현하는 개발자가 객체가 가지는 책임을 얼마나 잘 구분할 수 있는지에 따라 달렸습니다.</p>\n<p>OAuth2Client는 두 가지 일을 처리합니다.</p>\n<ol>\n<li>액세스 토큰을 요청</li>\n<li>사용자 정보를 요청</li>\n</ol>\n<p>두 가지 일은 OAuth2 인증의 흐름으로는 하나의 작업으로 볼 수 있겠지만 객체가 가지는 책임은 두 가지 책임을 지고 있습니다.</p>\n<p>따라서, 엑세스 토큰만 요청하는 클래스와 사용자 정보만 요청하는 클래스로 나눠 설계할 수 있습니다.</p>\n<h4>KakaoOAuth2AccessTokenClient</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenClient</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://kauth.kakao.com/oauth/token\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenClient</span><span class=\"token punctuation\">(</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.grant-type}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.client-id}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.redirect-uri}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">,</span>\n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.client-secret}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> clientSecret<span class=\"token punctuation\">,</span>  \n        <span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder  \n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grantType <span class=\"token operator\">=</span> grantType<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientId <span class=\"token operator\">=</span> clientId<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redirectUri <span class=\"token operator\">=</span> redirectUri<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientSecret <span class=\"token operator\">=</span> clientSecret<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getAccessTokenHeaders</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token function\">requestAccessToken</span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">HttpHeaders</span> <span class=\"token function\">getAccessTokenHeaders</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">,</span> grantType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">,</span> clientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">,</span> redirectUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_secret\"</span><span class=\"token punctuation\">,</span> clientSecret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> headers<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">requestAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span> headers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoAccessTokenResponse</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ACCESS_TOKEN_URL</span><span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">,</span>  \n                <span class=\"token class-name\">KakaoAccessTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">accessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClientErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoOAuth2Error</span> kakaoOAuth2Error <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getResponseBodyAs</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KakaoOAuth2Error</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>kakaoOAuth2Error<span class=\"token punctuation\">.</span><span class=\"token function\">isErrorCodeKOE320</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_INVALID_CODE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token punctuation\">}</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>KakaoOAuth2UserInfoClient</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2UserInfoClient</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://kapi.kakao.com/v2/user/me\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoOAuth2UserInfoClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getUserInfoHeaders</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token function\">requestUserInfo</span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">HttpHeaders</span> <span class=\"token function\">getUserInfoHeaders</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setBearerAuth</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> headers<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">requestUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span> headers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoUserInfo</span> kakaoUserInfo <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_INFO_URL</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n                    <span class=\"token class-name\">KakaoUserInfo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>  \n                <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token keyword\">return</span> kakaoUserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">toUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClientErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고 기존의 <code class=\"language-text\">KakaoOAuth2Client</code>는 다음과 같이 코드를 수정할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2Client</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuth2Client</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenClient</span> accessTokenClient<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">KakaoOAuth2UserInfoClient</span> userInfoClient<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoOAuth2Client</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KakaoOAuth2AccessTokenClient</span> accessTokenClient<span class=\"token punctuation\">,</span> <span class=\"token class-name\">KakaoOAuth2UserInfoClient</span> userInfoClient<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>accessTokenClient <span class=\"token operator\">=</span> accessTokenClient<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>userInfoClient <span class=\"token operator\">=</span> userInfoClient<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">return</span> accessTokenClient<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">return</span> userInfoClient<span class=\"token punctuation\">.</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제부터 <code class=\"language-text\">KakaoOAuth2Client</code> 클래스는 책임을 분리한 클래스에 요청을 위임하는 역할을 합니다.</p>\n<h4>ResponseErrorHandler</h4>\n<p>하지만 아직도 여전히 추한 try-catch가 코드에 남아있습니다.</p>\n<p><code class=\"language-text\">RestTemplate</code> 클래스에서 발생한 예외를 처리하기 위해 어쩔 수 없이 try-catch문을 사용해야 합니다.</p>\n<p>그런데 여기서 잠깐,</p>\n<p>저희는 스프링을 사용하며 컨트롤러, 서비스 레이어에 try-catch를 잘 사용하지 않습니다.</p>\n<p>오히려 예외를 처리하지 않고 던져버립니다.</p>\n<p>그러는 이유는 요청의 예외를 전역적으로 처리해 주는 <code class=\"language-text\">@ControllerAdvice</code>를 사용하기 때문입니다.</p>\n<p><code class=\"language-text\">RestTemplate</code> 클래스에서도 <code class=\"language-text\">@ControllerAdvice</code> 같은 역할을 할 수 있는 클래스가 있습니다.</p>\n<p>바로 <code class=\"language-text\">ResponseErrorHandler</code> 입니다.</p>\n<p><code class=\"language-text\">ResponseErrorHandler</code>는 인터페이스로 다음과 같은 두 개의 추상 메소드를 가지고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ResponseErrorHandler</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">boolean</span> <span class=\"token function\">hasError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClientHttpResponse</span> response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">void</span> <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClientHttpResponse</span> response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>사실 이미 <code class=\"language-text\">RestTemplate</code>에서는 기본적인 <code class=\"language-text\">ResponseErrorHandler</code>가 등록되어 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RestTemplate</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">InterceptingHttpAccessor</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">RestOperations</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ResponseErrorHandler</span> errorHandler <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DefaultResponseErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>따라서 기존의 <code class=\"language-text\">ResponseErrorHandler</code>를 사용하지 않고 커스텀한 에러 핸들러를 만들어 사용하면 예외 처리에 관한 로직을 분리할 수 있습니다.</p>\n<h4>KakaoOAuth2AccessTokenErrorHandler</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenErrorHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">DefaultResponseErrorHandler</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClientHttpResponse</span> response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatusCodeException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">HttpStatusCode</span> statusCode <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getStatusCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token function\">handle4xxError</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token function\">handle5xxError</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle4xxError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatusCode</span> statusCode<span class=\"token punctuation\">,</span> <span class=\"token class-name\">HttpStatusCodeException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">.</span><span class=\"token function\">is4xxClientError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token class-name\">KakaoOAuth2ErrorResponse</span> errorResponse <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">getResponseBodyAs</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KakaoOAuth2ErrorResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n            <span class=\"token function\">handleErrorCode</span><span class=\"token punctuation\">(</span>errorResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleErrorCode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KakaoOAuth2ErrorResponse</span> errorResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token function\">handleKOE320Error</span><span class=\"token punctuation\">(</span>errorResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_INVALID_REQUEST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleKOE320Error</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">KakaoOAuth2ErrorResponse</span> errorResponse<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>errorResponse <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> errorResponse<span class=\"token punctuation\">.</span><span class=\"token function\">isErrorCodeKOE320</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_INVALID_CODE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle5xxError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatusCode</span> statusCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">.</span><span class=\"token function\">is5xxServerError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_PROVIDER_NOT_RESPONSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">KakaoOAuth2ErrorResponse</span><span class=\"token punctuation\">(</span>  \n        <span class=\"token class-name\">String</span> error<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@JsonProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error_description\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> errorDescription<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@JsonProperty</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error_code\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> errorCode  \n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n  \n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isErrorCodeKOE320</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">Objects</span><span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>errorCode<span class=\"token punctuation\">,</span> <span class=\"token string\">\"KOE320\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>KakaoOAuth2UserInfoErrorHandler</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2UserInfoErrorHandler</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">DefaultResponseErrorHandler</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ClientHttpResponse</span> response<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">IOException</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpStatusCode</span> statusCode <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">getStatusCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token function\">handle4xxError</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token function\">handle5xxError</span><span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">INTERNAL_SERVER_ERROR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle4xxError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatusCode</span> statusCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">.</span><span class=\"token function\">is4xxClientError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_INVALID_REQUEST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handle5xxError</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatusCode</span> statusCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>statusCode<span class=\"token punctuation\">.</span><span class=\"token function\">is5xxServerError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InternalServerException</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ErrorCode</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OAUTH2_PROVIDER_NOT_RESPONSE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token punctuation\">}</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 에러 핸들러를 적용한 OAuth2Client는 다음과 같이 코드가 변경됩니다.</p>\n<h4>KakaoOAuth2AccessTokenClient</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenClient</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://kauth.kakao.com/oauth/token\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenClient</span><span class=\"token punctuation\">(</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.grant-type}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> grantType<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.client-id}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">,</span>  \n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.redirect-uri}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">,</span>\n        <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${festago.oauth2.kakao.client-secret}\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> clientSecret<span class=\"token punctuation\">,</span>  \n        <span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder  \n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grantType <span class=\"token operator\">=</span> grantType<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientId <span class=\"token operator\">=</span> clientId<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redirectUri <span class=\"token operator\">=</span> redirectUri<span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clientSecret <span class=\"token operator\">=</span> clientSecret<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder\n            <span class=\"token punctuation\">.</span><span class=\"token function\">errorHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">KakaoOAuth2AccessTokenErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getAccessTokenHeaders</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token function\">requestAccessToken</span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">HttpHeaders</span> <span class=\"token function\">getAccessTokenHeaders</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">,</span> grantType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">,</span> clientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">,</span> redirectUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_secret\"</span><span class=\"token punctuation\">,</span> clientSecret<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> headers<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">requestAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span> headers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">KakaoAccessTokenResponse</span> response <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span><span class=\"token constant\">ACCESS_TOKEN_URL</span><span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">,</span>  \n            <span class=\"token class-name\">KakaoAccessTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">accessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>KakaoOAuth2UserInfoClient</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2UserInfoClient</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://kapi.kakao.com/v2/user/me\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoOAuth2UserInfoClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder\n            <span class=\"token punctuation\">.</span><span class=\"token function\">errorHandler</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">KakaoOAuth2UserInfoErrorHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token function\">getUserInfoHeaders</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token function\">requestUserInfo</span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">HttpHeaders</span> <span class=\"token function\">getUserInfoHeaders</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setBearerAuth</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> headers<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">requestUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span> headers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">KakaoUserInfo</span> kakaoUserInfo <span class=\"token operator\">=</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span><span class=\"token constant\">USER_INFO_URL</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>  \n                <span class=\"token class-name\">KakaoUserInfo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> kakaoUserInfo<span class=\"token punctuation\">.</span><span class=\"token function\">toUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이처럼 예외를 처리하는 책임을 가진 객체로 분리하여, 요청을 보내는 객체에는 예외를 처리하는 코드 하나 없이 오로지 비즈니스 로직만 남게 된 것을 볼 수 있습니다.</p>\n<h3>새로운 OAuth2 클라이언트의 추가</h3>\n<p>서비스에서 사용하는 <code class=\"language-text\">OAuth2Client</code>는 인터페이스입니다.</p>\n<p>인터페이스로 설계하여, OAuth2 서비스 제공자가 바뀌더라도 쉽게 교체할 수 있고, 모의 OAuth2Client 객체를 만들어서 테스트할 때 외부 API의 연동 없이 테스트할 수 있습니다.</p>\n<p>하지만 이렇게 인터페이스를 사용하도록 만들어도, 인스턴스의 필드가 하나이기 때문에 추가적인 OAuth2Client를 사용하려면 서비스 제공자마다 서비스 클래스를 만들거나, 필드와 메소드가 생길 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">KakaoOAuth2Service</span><span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NaverOAuth2Service</span><span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 또는</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuth2Client</span> kakaoOAuth2Client<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuth2Client</span> naverOAuth2Client<span class=\"token punctuation\">;</span>\n    \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loginKakaoOAuth2</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">loginKakaoOAuth2</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이것은 단일 책임 원칙을 지켰다고 할 수 있겠지만, 중복된 코드가 생기게 되고 새로운 서비스 제공자가 생길 때 새로운 메소드를 추가해 줘야 합니다.</p>\n<p>그렇다면 어떻게 하나의 필드로 여러 <code class=\"language-text\">OAuth2Client</code>를 사용할 수 있을까요?</p>\n<p>스프링은 의존성을 주입할 때 컬렉션으로 의존성을 주입해 주는 기능을 제공합니다.</p>\n<p>따라서 다음과 같이 여러 <code class=\"language-text\">OAuth2Client</code>를 <code class=\"language-text\">List</code> 형식으로 받을 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2Clients<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2Clients<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>oAuth2Clients <span class=\"token operator\">=</span> oAuth2Clients<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이것이 바로 인터페이스를 의존하게 하면 얻을 수 있는 강력한 이점 중 하나입니다.</p>\n<p>그런데, 단순히 List 타입으로 받았다고 해서 끝나는 것은 아닙니다.</p>\n<p>리스트 중에서 사용자가 원하는 서비스 제공자를 선택할 수 있어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuth2Client</span> <span class=\"token function\">getClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocialType</span> socialType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> oAuth2Clients<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>client <span class=\"token operator\">-></span> client<span class=\"token punctuation\">.</span>getSocialType <span class=\"token operator\">==</span> socialType<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">findAny</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 Stream을 활용해서 사용자가 원하는 서비스 제공자를 선택할 수 있겠지만, 매번 Stream을 사용하여 원하는 서비스 제공자를 찾는 작업은 비효율적입니다.</p>\n<p>이때는 List 자료구조를 사용하는 것 보다 Map 자료구조를 사용하면 효율적일 것입니다.</p>\n<p>스프링은 Map 타입으로도 의존성 주입을 제공합니다.</p>\n<p>하지만 Map으로 의존성을 주입받으면 Key가 String인 <code class=\"language-text\">kakaoOAuth2Client</code>와 같이 지정됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2ClientMap<span class=\"token punctuation\">;</span></code></pre></div>\n<p>따라서 다음과 같이 의존성 주입은 List로 받은 뒤, 내부에서 Map으로 변환시키면 Key가 Enum 타입인 Map을 사용할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2ClientMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EnumMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2Clients<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuth2Client</span> oAuth2Client<span class=\"token operator\">:</span> oAuth2Clients<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        oAuth2ClientMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getSocialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> oAuth2Client<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 다음과 같이 특정 클라이언트를 빠르게 찾아올 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuth2Clients</span> <span class=\"token function\">getOAuth2Client</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocialType</span> socialType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofNullable</span><span class=\"token punctuation\">(</span>oAuth2ClientMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>socialType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n        <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>하지만 이것 또한 완벽하게 해결한 것은 아닙니다.</p>\n<p>필드에 <code class=\"language-text\">OAuth2Client</code>에 대한 자료구조가 그대로 노출이 되고 있습니다.</p>\n<p><code class=\"language-text\">AuthService</code> 클래스에서 필요한 기능은 SocialType에 맞는 OAuth2Client만 선택하는 것입니다.</p>\n<p><code class=\"language-text\">AuthService</code> 클래스는 Map에 대한 기능을 자세히 알 필요는 없습니다.</p>\n<p>이것은 저희가 레벨1부터 배워온 방법을 사용하면 쉽게 해결할 수 있습니다.</p>\n<p>바로 <code class=\"language-text\">일급 컬렉션</code>으로 만드는 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuth2Clients</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2ClientMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">EnumMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuth2Clients</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">OAuth2Client</span><span class=\"token punctuation\">></span></span> oAuth2Clients<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuth2Client</span> oAuth2Client<span class=\"token operator\">:</span> oAuth2Clients<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            oAuth2ClientMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getSocialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> oAuth2Client<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuth2Client</span> <span class=\"token function\">getClient</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocialType</span> socialType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofNullable</span><span class=\"token punctuation\">(</span>oAuth2ClientMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>socialType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고 <code class=\"language-text\">AuthService</code>의 코드는 다음과 같이 변합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuth2Clients</span> oAuth2Clients<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">LoginResponse</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SocialType</span> socialType<span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token class-name\">OAuth2Client</span> oAuth2Client <span class=\"token operator\">=</span> oAuth2Clients<span class=\"token punctuation\">.</span><span class=\"token function\">getClient</span><span class=\"token punctuation\">(</span>socialType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> accessToken <span class=\"token operator\">=</span> oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token class-name\">UserInfo</span> userInfo <span class=\"token operator\">=</span> oAuth2Client<span class=\"token punctuation\">.</span><span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token class-name\">Member</span> member <span class=\"token operator\">=</span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findBySocialIdAndSocialType</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">socialId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> socialType<span class=\"token punctuation\">)</span>  \n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElseGet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> memberRepository<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">toMember</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LoginResponse</span><span class=\"token punctuation\">(</span>authProvider<span class=\"token punctuation\">.</span><span class=\"token function\">provide</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">nickname</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span> </code></pre></div>\n<p>이제 새로운 OAuth2Client가 추가되어도 기존의 코드를 변경할 필요는 전혀 없어집니다.</p>\n<p>또한 로컬 환경 또는 테스트 환경을 위한 모의 OAuth2Client를 만들더라도 <code class=\"language-text\">@Profile</code>  어노테이션의 사용으로 운영 환경에서는 전혀 영향을 주지 않게 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>  \n<span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"!prod\"</span><span class=\"token punctuation\">)</span>  \n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FestagoOAuth2Client</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuth2Client</span> <span class=\"token punctuation\">{</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">PROFILE_IMAGE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"https://placehold.co/150x150\"</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">></span></span> userInfoMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">FestagoOAuth2Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        userInfoMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getSocialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"member1\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PROFILE_IMAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        userInfoMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getSocialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"member2\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PROFILE_IMAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n        userInfoMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"3\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getSocialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"member3\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">PROFILE_IMAGE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">getUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">ofNullable</span><span class=\"token punctuation\">(</span>userInfoMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BadRequestException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>  \n  \n    <span class=\"token annotation punctuation\">@Override</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">SocialType</span> <span class=\"token function\">getSocialType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">SocialType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">FESTAGO</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>결론</h2>\n<p>OAuth2를 사용한 인증 기능을 구현할 때, 스프링이 제공하는 의존성 주입 기능과 인터페이스를 사용한 다형성 활용 등, 객체 지향 설계를 따라 코드를 구현하면 변경에 유연하고 가독성이 높은 코드를 만들 수 있습니다.</p>\n<p>저희 서비스 특성상 새로운 OAuth2 서비스 제공자가 추가될 확률은 낮겠지만, 레벨 1, 2 과정을 배우며 습득한 객체 지향 설계 원칙을 이렇게 서비스에 녹여냈다는 점이 뿌듯한 것 같습니다.</p>","frontmatter":{"title":"페스타고의 인증 - OAuth2를 선택하고 적용한 방법","date":"August 20, 2023","update":"August 20, 2023","tags":["OAuth2"],"series":null},"fields":{"slug":"/oauth2-select-and-apply/","readingTime":{"minutes":21.65}}},"seriesList":{"edges":[{"node":{"id":"9ecb7f42-84ec-536a-9bfc-a3affcb87512","fields":{"slug":"/oauth2-select-and-apply/"},"frontmatter":{"title":"페스타고의 인증 - OAuth2를 선택하고 적용한 방법"}}},{"node":{"id":"1c28c731-cebd-5aab-b9bd-a5c397bf9c7a","fields":{"slug":"/oauth2-multiple-user-auth/"},"frontmatter":{"title":"페스타고의 인증 - 여러 사용자의 인증과 인가"}}},{"node":{"id":"b2e904f3-69c7-5c99-96e7-9555aaddc0e2","fields":{"slug":"/concurrency-redis/"},"frontmatter":{"title":"선착순 티켓팅에 Redis 도입하기"}}},{"node":{"id":"337eca9e-cd03-5e90-9d8f-d0b86e0ce4b9","fields":{"slug":"/facade-service/"},"frontmatter":{"title":"Facade 객체를 활용해 트랜잭션에서 외부 API 통신 분리하기"}}},{"node":{"id":"9ef33612-c159-552c-ba72-40903662c51c","fields":{"slug":"/event-singlelivedata/"},"frontmatter":{"title":"LiveData로 이벤트 처리하기: SingleLiveData"}}},{"node":{"id":"efd29a38-290b-5064-a87e-65f3d5ea4643","fields":{"slug":"/livedata-to-flow/"},"frontmatter":{"title":"Refactoring LiveData to Flow"}}}]},"previous":null,"next":{"fields":{"slug":"/oauth2-multiple-user-auth/"},"frontmatter":{"title":"페스타고의 인증 - 여러 사용자의 인증과 인가"}}},"pageContext":{"id":"9ecb7f42-84ec-536a-9bfc-a3affcb87512","series":null,"previousPostId":null,"nextPostId":"1c28c731-cebd-5aab-b9bd-a5c397bf9c7a"}},"staticQueryHashes":[],"slicesMap":{}}